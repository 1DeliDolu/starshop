# ⚙️ Part Entity / Parça Varlığı

Ana sayfada `Starship` varlığımız sayesinde zaten uzay gemileri gösteriliyor. Ama artık bir adım ileri gitme zamanı. Her `Starship`te kullanılan bireysel parçaları takip etmemiz gerekiyor. Plan şöyle: her parça yalnızca bir `Starship`e ait olacak ve her `Starship` birçok parçaya sahip olacak. Ancak ilişkilere geçmeden önce, basit başlamalıyız: bu parçaları takip edecek yeni bir `entity`'ye ihtiyacımız var! Terminali açın, yeni bir sekme oluşturun (çünkü sunucumuz hâlâ çalışıyor) ve şu komutu çalıştırın:

```shell
symfony console make:entity
```

👉 Bu komut, yeni bir `entity` oluşturmak için etkileşimli bir sihirbaz başlatır.

Adını `StarshipPart` koyun, `broadcasting` adımını atlayın ve birkaç alan ekleyin: `name` bir `string` olacak ve `nullable` olmayacak, `price` bir `integer` olacak (kredi cinsinden elbette) ve o da `nullable` olmayacak. Son olarak, `notes` alanı `text` türünde olacak (daha uzun metinler için) ve `nullable` olacaktır. Bu alanları ekledikten sonra, şu komutla yeni bir `migration` oluşturun:

```shell
symfony console make:migration
```

👉 Bu komut, yeni tanımlanan `entity` için veritabanı geçişi (migration) dosyası oluşturur.

## Running Migrations and Adding Timestamps / Geçişleri Çalıştırmak ve Zaman Damgaları Eklemek

Artık `migration`lara bakarsanız, sadece yeni oluşturduğumuz dosyayı görürsünüz: önceki dersteki eski migration’ları temizledim.

```php
//migrations/Version20250801065720.php

// ... lines 1 - 12
final class Version20250306155858 extends AbstractMigration
{
// ... lines 15 - 19
    public function up(Schema $schema): void
    {
        // this up() migration is auto-generated, please modify it to your needs
        $this->addSql('CREATE TABLE starship_part (id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL, name VARCHAR(255) NOT NULL, price INT NOT NULL, notes TEXT DEFAULT NULL, PRIMARY KEY(id))');
    }
// ... lines 25 - 30
}
```

👉 Bu kod, `starship_part` adında bir tabloyu veritabanında oluşturur.

Şimdi bunu çalıştırın:

```shell
symfony console doctrine:migrations:migrate
```

👉 Bu komut, tüm `migration`ları veritabanına uygular.

Veritabanı tablosu hazır! Ancak tüm `entity`lerime eklemeyi sevdiğim iki alan daha var: `createdAt` ve `updatedAt`. Bunları `Starship` içerisinde, `TimestampableEntity` içinde görebilirsiniz.

```php
// src/Entity/Starship.php
use Gedmo\Timestampable\Traits\TimestampableEntity;
// ... lines 1 - 11
class Starship
{
    use TimestampableEntity;
// ... lines 15 - 137
}
```

👉 Bu `trait`, `createdAt` ve `updatedAt` alanlarını otomatik olarak ayarlar.

Aynısını alıp `StarshipPart`'ın en üstüne yapıştırın. Bu iki özellik, önceki derste yüklediğimiz bir kütüphane sayesinde otomatik olarak ayarlanır. İki yeni alan eklediğimiz için yeni bir `migration` daha gereklidir:

```shell
symfony console make:migration
```

👉 Bu komut, zaman damgalarını içeren yeni bir `migration` dosyası oluşturur.

Ve sonra:

```shell
symfony console doctrine:migrations:migrate
```

👉 Bu komutla yeni `migration`ı uygularız.

## 🧪 Using Factories to Create Dummy Objects / Sahte Nesneler Oluşturmak için Factory Kullanmak

Önceki derste, bir sürü sahte veri oluşturmak için `Foundry` adında harika bir kütüphane kullandık. Şimdi `StarshipPart` için aynısını yapacağız. 1. adım – henüz yok – bir `factory` oluşturmaktır:

```shell
symfony console make:factory
```

👉 Bu komut, belirtilen `entity` için bir `factory` sınıfı oluşturur.

Şuraya gidip bakın: `src/Factory/StarshipPartFactory.php`. Her alan için bazı varsayılanlar ekledi, ama bunu daha ilginç hale getirebiliriz. Dosyanın en üstüne bazı örnek parça verilerini içeren kodu yapıştırın. Ayrıca `defaults()` fonksiyonundaki `return` ifadesini, bu verileri kullanan bir kodla değiştirin.

```php
//src/Factory/StarshipPartFactory.php

// ... lines 1 - 10
final class StarshipPartFactory extends PersistentProxyObjectFactory
{
    private static array $partIdeas = [
        'warp core' => 'looks cool AND zoom',
        'shield generator' => 'in case you run into any Borg',
        'captain\'s chair' => 'just slightly more comfortable than the others',
        'fuzzy dice' => 'obviously',
        'photon torpedoes' => 'for when the fuzzy dice don\'t work',
        'holodeck' => 'parental controls? No way!',
        'Tactical Whoopee Cushion Array' => 'can\'t beat them? Embarrass them!',
        'Temporal Seat Warmers' => 'warm your seat before you sit down',
        'Food Replicator' => 'Earl Grey, hot',
        'Self-Destruct Button Cover' => 'for when you have a cat',
        'Redshirt Dispenser' => 'Instantly replenishes expendable crew members.',
    ];
// ... lines 26 - 44
    protected function defaults(): array|callable
    {
        $randomPartKey = self::faker()->randomKey(self::$partIdeas);
        $randomPart = [$randomPartKey, self::$partIdeas[$randomPartKey]];
        return [
            'name' => $randomPart[0],
            'notes' => $randomPart[1],
            'price' => self::faker()->randomNumber(5),
        ];
    }
// ... lines 56 - 65
}
```

👉 Bu `factory`, rastgele parça adı, açıklama ve fiyat üreterek sahte `StarshipPart` nesneleri oluşturur.

Son olarak bunu `fixtures` içinde kullanın. Dosyanın en altına gidip 50 rastgele parça oluşturun:

```php
// src/DataFixtures/AppFixtures.php

// ... lines 1 - 10
class AppFixtures extends Fixture
{
    public function load(ObjectManager $manager): void
    {
// ... lines 15 - 38
        StarshipFactory::createMany(20);
        StarshipPartFactory::createMany(50);
    }
}
````

👉 Bu `fixture`, 20 `Starship` ve 50 `StarshipPart` nesnesi oluşturur.

Terminale dönün ve şu komutu çalıştırın:

```shell
symfony console doctrine:fixtures:load
```

👉 Bu komut, tüm sahte verileri veritabanına yükler.

Veritabanındaki yeni parçaları kontrol etmek için:

```shell
symfony console doctrine:query:sql "select * from starship_part";
```

👉 Bu SQL komutu, `starship_part` tablosundaki tüm verileri listeler.

Ve sadece birkaç satır kodla, veritabanında 50 rastgele parçamız oldu. Sıradaki adım: bu parçaları ait oldukları gemilere bağlayarak ilk ilişkimizi oluşturmak – yani `ManyToOne` ilişkisi.
