# 🔄 Many-to-Many but with Extra Data / Ekstra Verili Çoktan-Çoğa İlişki

`ManyToMany` ilişkiler, Doctrine'de veritabanımızda bir tabloya (`starship_droid`) sahip olup uygulamamızda karşılık gelen bir entity'nin olmadığı tek yerdir.

Ama burada bir durum var: Bu birleştirme tablosuna ekstra sütun ekleyemeyiz. Mesela, bir droid'in bir yıldız gemisine ne zaman atandığını takip etmek isteseydik? Bunun için bir `assignedAt` sütununa ihtiyacımız olurdu. Ama bunu ekleyemiyoruz!

`Many-to-Many` Yeterli Olmadığında
Çözüm, kolları sıvayıp işleri daha elle yönetmeye başlamaktır.

Artık `many-to-many` ilişkiyi tamamen kullanmayacağız. Bunun yerine, birleştirme tablosunu temsil eden yeni bir entity oluşturacağız. İlk olarak, `many-to-many` ilişkiyi geri alıyoruz (sadece property'lerle ilgileniyoruz, metotlarla değil). `Starship` içinde, `droids` property’sine elveda deyin:


```php
// src/Entity/Starship.php
// ... lines 1 - 15
class Starship
{
// ... lines 18 - 50
    /**
     * @var Collection<int, Droid>
     */
    #[ORM\ManyToMany(targetEntity: Droid::class, inversedBy: 'starships')]
    private Collection $droids;
// ... lines 56 - 227
}
```

👉 Bu bölümde, `Starship` entity’sindeki `droids` özelliğini kaldırıyoruz.

Ve `Droid` tarafında da, aynı şekilde `starships` many-to-many property’sini kaldırıyoruz:


```php
// src/Entity/Droid.php
// ... lines 1 - 10
class Droid
{
// ... lines 13 - 23
    /**
     * @var Collection<int, Starship>
     */
    #[ORM\ManyToMany(targetEntity: Starship::class, mappedBy: 'droids')]
    private Collection $starships;
// ... lines 29 - 89
}
```

👉 Bu bölümde, `Droid` entity’sindeki `starships` özelliğini kaldırıyoruz.

Her iki entity’de de constructor’ı temizleyin.

Terminalinizi açıp şu komutu çalıştırın:

```bash
symfony console doctrine:schema:update --dump-sql
```

👉 Bu komut, şu anda migration oluşturacak olsanız nasıl bir SQL çalışacağını gösterir.

Bu tam da beklediğimiz gibi: Artık `starship_droid` tablosu yok.


## 🧱 Creating a New Join Entity / Yeni Bir Birleştirme (Join) Entity’si Oluşturmak

Ama henüz migration’ı oluşturmayın! Birleştirme tablosunu istiyoruz ama şimdi onu temsil edecek bir entity’ye ihtiyacımız var. Şu komutu çalıştırın:

```bash
symfony console make:entity StarshipDroid
```

👉 Bu komut yeni bir entity oluşturur. `DroidAssignment` daha uygun bir isim olabilir ama `StarshipDroid` ne yaptığımızı daha iyi görselleştirir: Aynı veritabanı ilişkisini iki adet `ManyToOne` ile tekrar oluşturmak.

`assignedAt` alanını ekleyin ve bu join tablosundan `Starship` ve `Droid`’a ilişkiler kuracak iki özellik daha ekleyin.

Bunlar `ManyToOne` ilişkiler olacak ve `StarshipDroid`’i `Starship` ve `Droid` ile ilişkilendirecek.

## ⚡ The Migration that Does Nothing / Hiçbir Şey Yapmayan Migration

Şimdi migration’ı oluşturun:

```bash
symfony console make:migration
```

👉 Bu komut migration dosyasını oluşturur.

Ve kontrol edin. Pek çok değişiklik var gibi görünebilir ama dikkatlice bakın: Sadece foreign key kısıtlamalarını kaldırıyor, birincil anahtar ekliyor ve foreign key’i yeniden oluşturuyor:


```php
// migrations/Version20250315183623.php
// ... lines 1 - 12
final class Version20250315183623 extends AbstractMigration
{
// ... lines 15 - 19
    public function up(Schema $schema): void
    {
        // this up() migration is auto-generated, please modify it to your needs
        $this->addSql('ALTER TABLE starship_droid DROP CONSTRAINT FK_1C7FBE889B24DF5');
        $this->addSql('ALTER TABLE starship_droid DROP CONSTRAINT FK_1C7FBE88AB064EF');
        $this->addSql('ALTER TABLE starship_droid DROP CONSTRAINT starship_droid_pkey');
        $this->addSql('ALTER TABLE starship_droid ADD id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL');
        $this->addSql('ALTER TABLE starship_droid ADD assigned_at TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL');
        $this->addSql('ALTER TABLE starship_droid ADD CONSTRAINT FK_1C7FBE889B24DF5 FOREIGN KEY (starship_id) REFERENCES starship (id) NOT DEFERRABLE INITIALLY IMMEDIATE');
        $this->addSql('ALTER TABLE starship_droid ADD CONSTRAINT FK_1C7FBE88AB064EF FOREIGN KEY (droid_id) REFERENCES droid (id) NOT DEFERRABLE INITIALLY IMMEDIATE');
        $this->addSql('ALTER TABLE starship_droid ADD PRIMARY KEY (id)');
    }
// ... lines 32 - 44
}
```

👉 Bu migration aslında veritabanında gerçek bir değişiklik yapmaz.

Şimdi şunu çalıştırın:

```bash
symfony console doctrine:migrations:migrate
```

👉 Bu komut migration’ı uygular.
