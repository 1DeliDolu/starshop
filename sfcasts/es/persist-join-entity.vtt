WEBVTT

00:00:01.066 --> 00:00:06.276 align:middle
Hemos refactorizado nuestra relación de muchos a muchos
para incluir una entidad de unión llamada StarshipDroid,

00:00:06.516 --> 00:00:10.046 align:middle
en lugar de confiar en que Doctrine
cree la tabla de unión por nosotros.

00:00:10.046 --> 00:00:14.306 align:middle
Recarga nuestras instalaciones, pero
no te quites el sombrero: ¡Error!

00:00:14.546 --> 00:00:18.436 align:middle
Propiedad no definida: App\Entity\Starship::$droids
Este error está siendo escupido

00:00:18.436 --> 00:00:20.966 align:middle
desde la línea 205 de Starship.

00:00:20.966 --> 00:00:21.616 align:middle
¿El culpable?

00:00:21.816 --> 00:00:23.146 align:middle
Nuestro método getDroids().

00:00:23.606 --> 00:00:26.406 align:middle
Pues duh, ¡acabamos de
eliminar la propiedad droids!

00:00:26.956 --> 00:00:35.126 align:middle
La solución rápida, duh otra
vez, es comentarla: Y ¡hurra!

00:00:35.126 --> 00:00:39.866 align:middle
Los accesorios vuelven a funcionar: Para descubrir el
arreglo correcto, hagamos algunas cosas manualmente:

00:00:39.866 --> 00:00:44.166 align:middle
$ship = StarshipFactorypodríamos
utilizar createOne(),

00:00:44.216 --> 00:00:45.876 align:middle
pero mejor cojamos uno al azar.

00:00:46.526 --> 00:00:50.636 align:middle
Utiliza también el truco _real() para
obtener el objeto real, no un proxy.

00:00:51.456 --> 00:00:56.966 align:middle
Luego haz lo mismo con $droid = DroidFactory, de
nuevo cogiendo uno al azar y llamando a _real()

00:00:56.966 --> 00:01:01.456 align:middle
sobre él: Antes podíamos
utilizar $ship->addDroid($droid)

00:01:01.456 --> 00:01:02.766 align:middle
para añadir un droide a Starship.

00:01:03.186 --> 00:01:04.046 align:middle
Pero ¡ya no!

00:01:04.046 --> 00:01:06.846 align:middle
Está haciendo referencia a
la obsoleta propiedad droids.

00:01:07.356 --> 00:01:10.646 align:middle
Ahora se llama starshipDroids,
y como habrás adivinado,

00:01:10.896 --> 00:01:13.116 align:middle
es una colección de entidades StarshipDroid.

00:01:13.656 --> 00:01:18.806 align:middle
Deshazte de $ship->addDroid() y en su lugar
di $starshipDroid igual a new StarshipDroid(),

00:01:18.836 --> 00:01:22.396 align:middle
luego $starshipDroid->setDroid(),
no $ship sino $droid.

00:01:22.396 --> 00:01:26.576 align:middle
Y pon $starshipDroid->setStarship($ship).

00:01:27.286 --> 00:01:30.806 align:middle
Estamos creando manualmente la entidad y
estableciendo esas relaciones muchos-a-uno.

00:01:30.806 --> 00:01:35.126 align:middle
Por último, como las estamos ensamblando
a mano, tenemos que persistirlas

00:01:35.126 --> 00:01:38.646 align:middle
y vaciarlas utilizando
$manager->persist($starshipDroid),

00:01:38.866 --> 00:01:44.126 align:middle
y $manager->flush(): Sin duda es
más trabajo, pero es bastante sencillo.

00:01:44.126 --> 00:01:49.116 align:middle
Dale una vuelta a los accesorios: Y
echa un vistazo a la base de datos con:

00:01:49.116 --> 00:01:52.196 align:middle
symfony console doctrine:query:sql "SELECT *

00:01:52.196 --> 00:01:57.106 align:middle
FROM starship_droid" Estamos seleccionando
en esa tabla de unión y ¡sí!

00:01:57.486 --> 00:02:00.066 align:middle
Una entrada para el Starship, y el Droid.

00:02:00.066 --> 00:02:01.616 align:middle
Hasta aquí, todo bien.

00:02:02.016 --> 00:02:03.076 align:middle
Actualiza la página de inicio.

00:02:03.656 --> 00:02:04.706 align:middle
¡Otro error!

00:02:05.066 --> 00:02:09.736 align:middle
[Error semántico] línea 0,
col 55 cerca de 'droids WHERE':

00:02:10.026 --> 00:02:13.306 align:middle
La clase App\Entity\Starship no tiene
ninguna asociación llamada droids.

00:02:13.816 --> 00:02:15.906 align:middle
Parece que tenemos un problema
de consulta entre manos.

00:02:16.556 --> 00:02:20.626 align:middle
Es hora de arremangarse y sumergirse
en src/Repository/StarshipRepository.

00:02:21.386 --> 00:02:23.346 align:middle
Nuestra unión se está fundiendo un poco.

00:02:23.816 --> 00:02:28.066 align:middle
Nos estamos uniendo a s.droids, pero la
propiedad droids ha abandonado el edificio.

00:02:28.616 --> 00:02:30.346 align:middle
Tenemos que unirnos a starshipDroids.

00:02:30.706 --> 00:02:33.476 align:middle
Cambia s.droids por s.starshipDroids.

00:02:33.896 --> 00:02:37.876 align:middle
Y para mayor claridad, llámalo
starshipDroid, porque es lo que realmente es.

00:02:38.396 --> 00:02:42.886 align:middle
Ahora cuéntalos en lugar del
inexistente droids: Con esto solucionado

00:02:42.886 --> 00:02:44.886 align:middle
, actualizamos la página de inicio y...

00:02:45.036 --> 00:02:46.076 align:middle
¡otro error!

00:02:46.536 --> 00:02:49.046 align:middle
Es: Advertencia: Propiedad no
definida: App\Entity\Starship::$droids.

00:02:49.626 --> 00:02:52.776 align:middle
Esto viene de ship.droidNames en la
plantilla de la página de inicio.

00:02:53.356 --> 00:02:58.446 align:middle
Sabemos que cuando llamamos a ship.droidNames,
éste llama a $starship->getDroidNames()

00:02:59.026 --> 00:03:04.456 align:middle
y seguimos haciendo referencia a la propiedad droids:
A continuación, vamos a ocultar la entidad join

00:03:04.566 --> 00:03:08.766 align:middle
y hacer que esto funcione exactamente igual que
la relación ManyToMany que teníamos antes.

00:03:09.156 --> 00:03:09.796 align:middle
¡Mágico!
